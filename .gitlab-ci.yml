stages:
  - install
  - build
  - publish

variables:
  PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  DOCKER_REGISTRY: ""
  DOCKER_REGISTRY_USERNAME: "$DOCKER_REGISTRY_USERNAME"
  DOCKER_REGISTRY_PASSWORD: "$DOCKER_REGISTRY_PASSWORD"

cache:
  paths:
    - vendor/
  key: ${CI_COMMIT_REF_SLUG}

.docker-common:
  stage: publish
  trigger:
    include:
      - project: devops/gitlab-pipes
        file: /templates/docker-build-with-artifacts.gitlab-ci.yml
        ref: main
    strategy: depend

install:
  stage: install
  image: golang:alpine
  script:
    - apk add --no-cache --no-progress make git
    - make install
  artifacts:
    paths:
      - vendor/
  tags:
    - docker

build:
  stage: build
  image: golang:alpine
  script:
    - apk add --no-cache --no-progress make git
    - make -j4 build
    - ./dist/pipe --help
  artifacts:
    paths:
      - dist/
  tags:
    - docker

publish:
  extends: .docker-common
  variables:
    DOCKERFILE_CONTEXT: .
    DOCKER_IMAGE_NAME: cenk1cenk2/nginx-ingress
    IMAGE_TAGS: latest
  only:
    refs:
      - main
      - tags
